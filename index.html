<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Easy Image Text — Canvas Fix 210920250820</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#f6f8fb;padding:18px}
    .container{max-width:1100px;margin:auto;background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    input[type=file]{padding:6px}
    select,button,input[type=range]{padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff}
    #canvasGrid{display:flex;flex-direction:column;gap:12px}
    .canvasItem{width:100%;max-width:600px;border:1px solid #e6e6e6;padding:8px;border-radius:8px;background:#fff;position:relative;overflow:visible;margin:auto}
    .canvasItem canvas{display:block;width:100%;height:auto;background:#fafafa;border-radius:4px;position:relative;z-index:10}
    .thumb-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:8px;z-index:50;position:relative}
    .overlay{position:absolute;left:0;top:0;right:0;bottom:0;z-index:20;pointer-events:none}
    .shade{position:absolute;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:21;pointer-events:none}
    .crop-box{position:absolute;border:2px solid #0b74ff;background:transparent;z-index:30;pointer-events:auto;touch-action:none}
    .crop-box .size{position:absolute;top:-22px;right:0;background:rgba(0,0,0,0.6);color:#fff;font-size:11px;padding:3px 6px;border-radius:4px;z-index:31}
    .handle{width:14px;height:14px;background:#0b74ff;border:2px solid #fff;border-radius:2px;position:absolute;box-sizing:border-box;z-index:35;pointer-events:auto}
    .handle.tl{left:-9px;top:-9px;cursor:nwse-resize}
    .handle.tr{right:-9px;top:-9px;cursor:nesw-resize}
    .handle.bl{left:-9px;bottom:-9px;cursor:nesw-resize}
    .handle.br{right:-9px;bottom:-9px;cursor:nwse-resize}
    #progressBar{height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px}
    #progressBar i{display:block;height:100%;background:#0b74ff;width:0%;transition:width .15s}
    textarea{width:100%;height:160px;margin-top:12px;padding:8px;font-family:monospace}
    #cameraModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:9999}
    #cameraModal .box{background:#fff;padding:10px;border-radius:8px;max-width:420px;width:95%;text-align:center}
    video{width:100%;border-radius:6px;background:#000}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Easy Image Text — Canvas Fix</h1>

    <div class="row">
      <input id="fileInput" type="file" accept="image/*,application/pdf" multiple/>
      <select id="langSelect">
        <option value="auto">Auto-detect</option>
        <option value="eng">English</option>
        <option value="hin">Hindi</option>
        <option value="eng+hin">English+Hindi</option>
      </select>
      <label class="muted">BW threshold: <span id="thVal">128</span></label>
      <input id="thSlider" type="range" min="0" max="255" value="128"/>
    </div>

    <div class="row">
      <button id="btnOriginal">Original</button>
      <button id="btnNoShadow">No Shadow</button>
      <button id="btnLighten">Lighten</button>
      <button id="btnMagic">Magic Color</button>
      <button id="btnGray">Grayscale</button>
      <button id="btnBW">Black & White</button>
      <button id="btnEco">Eco</button>
      <button id="autoCrop">Auto-Crop</button>
    </div>

    <div class="row">
      <button id="exportPdfMulti">Export PDF</button>
      <button id="recognizeAll">OCR</button>
      <button id="openCamera">Camera</button>
      <button id="clearAll">Clear All</button>
      <button id="downloadAll">Download All</button>
    </div>

    <div id="progressBar"><i id="progressFill"></i></div>
    <div id="statusText" class="muted" style="margin-top:6px">Status: idle</div>
    <div id="canvasGrid"></div>
    <textarea id="resultText" placeholder="Recognized text will appear here..."></textarea>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal"><div class="box">
    <video id="cameraVideo" autoplay playsinline></video>
    <div style="margin-top:8px">
      <button id="cameraCapture">Capture</button>
      <button id="cameraClose">Close</button>
    </div>
  </div></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvasGrid = document.getElementById('canvasGrid');
    let items = [];

    function createCanvasItem(img, file){
      const wrap = document.createElement('div');
      wrap.className = 'canvasItem';

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      wrap.appendChild(canvas);

      const actions = document.createElement('div');
      actions.className = 'thumb-actions';
      actions.textContent = file ? file.name : "Captured";
      wrap.appendChild(actions);

      const item = {file, img, canvas, ctx, wrap};
      items.push(item);
      canvasGrid.appendChild(wrap);

      // force draw
      drawItem(item);
      return item;
    }

    function drawItem(item){
      if(!item || !item.img) return;
      const img = item.img;
      const c = item.canvas;
      const ctx = item.ctx;

      let w = img.width, h = img.height;
      if(w > 800){ h = Math.round(h*(800/w)); w = 800; }
      c.width = w; c.height = h;

      console.log("Drawing image", w, h);
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
    }

    // file input handler
    fileInput.addEventListener('change', ev=>{
      const files = Array.from(ev.target.files||[]);
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = ()=>{ createCanvasItem(img,f); URL.revokeObjectURL(url); };
        img.src = url;
      });
    });
  </script>
</body>
</html>
